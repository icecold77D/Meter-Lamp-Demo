<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BCM Lamp Overlay Demo</title>

  <!-- QRCode lib (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a27;
      --muted:#8aa0bf;
      --ok:#22c55e;
      --border:#223049;
      --btn:#1a2436;
      --btn2:#23314b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 700px at 30% 10%, #18233a 0%, var(--bg) 55%);
      color:#e7eefc;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      flex:1;
      min-width:260px;
    }
    h1{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:.5px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .qrcodeBox{
      background: rgba(18,26,39,.9);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px 8px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .qrMeta{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .qrMeta .label{
      font-size:12px;
      color:var(--muted);
    }
    .qrMeta .url{
      font-size:12px;
      max-width:280px;
      word-break:break-all;
      color:#cfe0ff;
      opacity:.9;
    }

    .panel{
      background: rgba(18,26,39,.72);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    /* Dashboard overlay area */
    .dashStage{
      position:relative;
      width:min(860px, 100%);
      margin: 0 auto 14px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
      background:#0a0f18;
    }
    .dashStage img.base{
      width:100%;
      display:block;
    }
    .dashStage img.overlay{
      position:absolute;
      left:0;
      top:0;
      width:100%;
      height:auto;
      display:none; /* hidden by default */
      pointer-events:none;
      filter: drop-shadow(0 0 10px rgba(34,197,94,.35));
    }

    /* Lamp selection grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .lampBtn{
      user-select:none;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(35,49,75,.75), rgba(18,26,39,.75));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px 10px 10px;
      display:flex;
      align-items:center;
      gap:10px;
      transition: transform .08s ease, border-color .12s ease, box-shadow .12s ease;
      min-height:64px;
    }
    .lampBtn:hover{ transform: translateY(-1px); }
    .lampBtn:active{ transform: translateY(0px) scale(.99); }

    .lampBtn img{
      width:44px;
      height:44px;
      object-fit:contain;
      border-radius:10px;
      background: rgba(0,0,0,.18);
      padding:6px;
      border: 1px solid rgba(255,255,255,.06);
      filter: grayscale(1) brightness(.95) opacity(.55);
      transition: filter .15s ease;
    }
    .lampBtn .meta{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .lampBtn .name{
      font-size:14px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lampBtn .hint{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .lampBtn.selected{
      border-color: rgba(34,197,94,.7);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12);
    }
    .lampBtn.selected img{
      filter: grayscale(0) brightness(1.05) opacity(1);
    }

    /* Controls */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
      justify-content:space-between;
    }
    .leftControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      cursor:pointer;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:#e7eefc;
      padding: 10px 14px;
      font-weight:700;
      letter-spacing:.2px;
      transition: transform .08s ease, opacity .15s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button:active{ transform: translateY(0px) scale(.99); }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .secondary{
      background: rgba(255,255,255,.04);
    }
    .status{
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.35;
      max-width: 520px;
    }
    .pill{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:#cfe0ff;
      font-size:12px;
      margin-left:6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>BCM 燈號疊圖動畫 Demo</h1>
        <div class="sub">
          ① 選擇燈號（可複選）→ ② 按「確認」→ ③ 隨機「同時/依序」＋隨機閃爍模式（3秒長亮/1秒閃/0.5秒閃）<br>
          你把本頁丟 GitHub Pages 後，右側 QRCode 會自動變成可掃的入口。
        </div>
      </div>

      <div class="qrcodeBox">
        <div id="qrcode"></div>
        <div class="qrMeta">
          <div class="label">掃描開啟本頁</div>
          <div class="url" id="pageUrl"></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <!-- Dashboard Stage -->
      <div class="dashStage" id="dashStage">
        <img class="base" src="pic.png" alt="dashboard" />
        <!-- overlays will be injected here -->
      </div>

      <!-- Lamp selection grid -->
      <div class="grid" id="lampGrid"></div>

      <div class="controls">
        <div class="leftControls">
          <button id="btnConfirm">確認</button>
          <button id="btnStop" class="secondary" disabled>停止/重置</button>
        </div>
        <div class="status" id="status">
          狀態：待選擇燈號 <span class="pill">可複選</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Config: lamps
    // ---------------------------
    const LAMPS = [
      { key: "LeftTurn",  name: "左轉方向燈",  hint:"BCM_LeftTurnCommand",     file:"BCM_LeftTurnCommand.png" },
      { key: "RightTurn", name: "右轉方向燈",  hint:"BCM_RightTurnCommand",    file:"BCM_RightTurnCommand.png" },
      { key: "FrontFog",  name: "前霧燈",      hint:"BCM_FrontFogLampStatus",  file:"BCM_FrontFogLampStatus.png" },
      { key: "RearFog",   name: "後霧燈",      hint:"BCM_RearFogLampStatus",   file:"BCM_RearFogLampStatus.png" },
      { key: "MainBeam",  name: "遠光燈",      hint:"BCM_MainBeamStatus",      file:"BCM_MainBeamStatus.png" },
      { key: "Position",  name: "示寬燈",      hint:"BCM_PoistionLampStatus",  file:"BCM_PoistionLampStatus.png" },
    ];

    // Random helpers
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const choice = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const sleep = (ms) => new Promise(res => setTimeout(res, ms));

    // UI refs
    const dashStage = document.getElementById("dashStage");
    const lampGrid  = document.getElementById("lampGrid");
    const btnConfirm= document.getElementById("btnConfirm");
    const btnStop   = document.getElementById("btnStop");
    const statusEl  = document.getElementById("status");

    // State
    const selected = new Set();              // lamp keys
    const overlayEls = new Map();            // lamp key -> overlay <img>
    let running = false;
    let stopFlag = false;

    // ---------------------------
    // Build overlays (stacked images)
    // ---------------------------
    function ensureOverlays() {
      for (const lamp of LAMPS) {
        if (overlayEls.has(lamp.key)) continue;
        const img = document.createElement("img");
        img.className = "overlay";
        img.src = lamp.file;
        img.alt = lamp.name;
        dashStage.appendChild(img);
        overlayEls.set(lamp.key, img);
      }
    }

    function hideAllOverlays(){
      for (const img of overlayEls.values()) img.style.display = "none";
    }

    function setOverlay(lampKey, on){
      const img = overlayEls.get(lampKey);
      if (!img) return;
      img.style.display = on ? "block" : "none";
    }

    // ---------------------------
    // Build lamp buttons
    // ---------------------------
    function renderLampButtons() {
      lampGrid.innerHTML = "";
      for (const lamp of LAMPS) {
        const btn = document.createElement("div");
        btn.className = "lampBtn";
        btn.dataset.key = lamp.key;

        btn.innerHTML = `
          <img src="${lamp.file}" alt="${lamp.name}">
          <div class="meta">
            <div class="name">${lamp.name}</div>
            <div class="hint">${lamp.hint}</div>
          </div>
        `;

        btn.addEventListener("click", () => {
          if (running) return; // running時不讓改選
          if (selected.has(lamp.key)) selected.delete(lamp.key);
          else selected.add(lamp.key);
          btn.classList.toggle("selected", selected.has(lamp.key));
          updateStatus();
        });

        lampGrid.appendChild(btn);
      }
    }

    function updateStatus(extra=""){
      const n = selected.size;
      const keys = [...selected];
      statusEl.innerHTML = `狀態：${n ? `已選擇 ${n} 個燈號` : "待選擇燈號"} <span class="pill">${n ? keys.join(" / ") : "可複選"}</span> ${extra}`;
    }

    // ---------------------------
    // Patterns
    // ---------------------------
    /**
     * pattern type:
     *  - steady: ON 3000ms, OFF 1000ms, repeat cycles
     *  - blink: toggle every interval (1000 or 500) for duration
     */
    async function runPattern(lampKey, pattern) {
      if (stopFlag) return;

      if (pattern.type === "steady") {
        const cycles = pattern.cycles ?? 2;
        for (let i=0; i<cycles; i++){
          if (stopFlag) return;
          setOverlay(lampKey, true);
          await sleep(pattern.onMs ?? 3000);
          if (stopFlag) return;
          setOverlay(lampKey, false);
          await sleep(pattern.offMs ?? 1000);
        }
        // end off
        setOverlay(lampKey, false);
        return;
      }

      if (pattern.type === "blink") {
        const interval = pattern.intervalMs ?? 1000;
        const duration = pattern.durationMs ?? 6000;
        const endAt = Date.now() + duration;

        let on = false;
        while (Date.now() < endAt) {
          if (stopFlag) break;
          on = !on;
          setOverlay(lampKey, on);
          await sleep(interval);
        }
        setOverlay(lampKey, false);
        return;
      }
    }

    function randomPattern(){
      const p = choice([
        { type:"steady", onMs:3000, offMs:1000, cycles: randInt(1,3) },      // 長亮3秒/暗1秒，重複1~3輪
        { type:"blink",  intervalMs:1000, durationMs: randInt(4000,9000) }, // 1秒閃 4~9秒
        { type:"blink",  intervalMs:500,  durationMs: randInt(4000,9000) }, // 0.5秒閃 4~9秒
      ]);
      return p;
    }

    // Randomly choose simultaneous or sequential
    function randomMode(){
      return Math.random() < 0.5 ? "simultaneous" : "sequential";
    }

    // ---------------------------
    // Run
    // ---------------------------
    async function runScenario() {
      if (running) return;
      ensureOverlays();
      hideAllOverlays();

      if (selected.size === 0) {
        updateStatus(`<span class="pill" style="border-color:rgba(244,63,94,.35);color:#ffd3dc;background:rgba(244,63,94,.10)">請先選燈號</span>`);
        return;
      }

      running = true;
      stopFlag = false;
      btnConfirm.disabled = true;
      btnStop.disabled = false;

      // Freeze selection UI visually
      for (const el of lampGrid.querySelectorAll(".lampBtn")) {
        el.style.opacity = "0.9";
      }

      const mode = randomMode();
      const chosenKeys = [...selected]; // preserve click order (DOM order), or you can shuffle if you want:
      // const chosenKeys = [...selected].sort(() => Math.random()-0.5); // shuffle order

      const plan = chosenKeys.map(k => ({ key:k, pattern: randomPattern() }));

      // show status
      const planText = plan.map(x => {
        if (x.pattern.type === "steady") return `${x.key}: 長亮3s/暗1s ×${x.pattern.cycles}`;
        if (x.pattern.type === "blink") return `${x.key}: 閃爍 ${x.pattern.intervalMs/1000}s`;
        return `${x.key}: ?`;
      }).join(" ｜ ");

      updateStatus(`<span class="pill">模式：${mode === "simultaneous" ? "同時" : "依序"}</span> <span class="pill">隨機方案</span><br><span style="color:var(--muted)">${planText}</span>`);

      try {
        if (mode === "simultaneous") {
          await Promise.all(plan.map(x => runPattern(x.key, x.pattern)));
        } else {
          for (const x of plan) {
            if (stopFlag) break;
            await runPattern(x.key, x.pattern);
            // 小緩衝：每顆燈之間隨機停一下（更像真人在操作）
            await sleep(randInt(150, 600));
          }
        }
      } finally {
        hideAllOverlays();
        running = false;
        btnConfirm.disabled = false;
        btnStop.disabled = true;

        for (const el of lampGrid.querySelectorAll(".lampBtn")) {
          el.style.opacity = "1";
        }
        updateStatus(`<span class="pill">完成</span>（可再按確認重跑一次隨機）`);
      }
    }

    function stopAndReset(){
      stopFlag = true;
      hideAllOverlays();
      running = false;
      btnConfirm.disabled = false;
      btnStop.disabled = true;
      updateStatus(`<span class="pill">已停止/重置</span>`);
    }

    // ---------------------------
    // QR Code of current page
    // ---------------------------
    function buildQRCode(){
      const url = window.location.href;
      document.getElementById("pageUrl").textContent = url;

      const qrDiv = document.getElementById("qrcode");
      qrDiv.innerHTML = "";
      // size auto-ish: 110
      new QRCode(qrDiv, {
        text: url,
        width: 110,
        height: 110,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    // ---------------------------
    // Init
    // ---------------------------
    ensureOverlays();
    renderLampButtons();
    updateStatus();
    buildQRCode();

    btnConfirm.addEventListener("click", runScenario);
    btnStop.addEventListener("click", stopAndReset);

    // If user resizes or the URL changes (rare), rebuild QR
    window.addEventListener("hashchange", buildQRCode);
  </script>
</body>
</html>
